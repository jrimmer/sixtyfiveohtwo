<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack - The Proving Grounds</title>
    <link rel="stylesheet" href="/provinggrounds/css/terminal.css">
</head>
<body>
    <div class="terminal">
        <div class="ascii-box">
<pre>
===============================================
             BLACKJACK
      "Get 21 without going bust!"
===============================================
</pre>
        </div>

        <% if (typeof error !== 'undefined' && error) { %>
        <div class="message message-error">
            Invalid bet amount!
        </div>
        <% } %>

        <div class="stats" style="margin: 20px 0;">
            <div class="stat">
                <span class="stat-label">Gold:</span>
                <span class="stat-value"><%= user.gold %></span>
            </div>
        </div>

        <% if (!game) { %>
        <!-- No active game, show bet form -->
        <h3>Place Your Bet</h3>
        <form action="/provinggrounds/games/blackjack/start" method="POST">
            <div class="form-group">
                <label for="bet">Bet Amount:</label>
                <input type="number" name="bet" id="bet" min="1" max="<%= user.gold %>" value="10">
            </div>
            <div class="form-group">
                <button type="submit">Deal Cards</button>
            </div>
        </form>
        <% } else { %>
        <!-- Active game -->
        <div class="stats" style="margin: 20px 0;">
            <div class="stat">
                <span class="stat-label">Current Bet:</span>
                <span class="stat-value"><%= game.bet %> gold</span>
            </div>
        </div>

        <h3>Dealer's Hand</h3>
        <div class="ascii-box">
            <% if (game.status === 'playing') { %>
            [<%= game.dealerHand[0].value %><%= game.dealerHand[0].suit %>] [??]
            <% } else { %>
            <% game.dealerHand.forEach(card => { %>
            [<%= card.value %><%= card.suit %>]
            <% }); %>
            <% } %>
            <% if (game.status !== 'playing') { %>
            <span style="color: var(--bright-color);"> = <%= game.dealerHand.reduce((sum, card) => {
                if (card.value === 'A') return sum + 11;
                if (['K','Q','J'].includes(card.value)) return sum + 10;
                return sum + parseInt(card.value);
            }, 0) %></span>
            <% } %>
        </div>

        <h3>Your Hand</h3>
        <div class="ascii-box">
            <% game.playerHand.forEach(card => { %>
            [<%= card.value %><%= card.suit %>]
            <% }); %>
            <span style="color: var(--bright-color);"> = <%= (function() {
                let value = 0, aces = 0;
                game.playerHand.forEach(card => {
                    if (card.value === 'A') { aces++; value += 11; }
                    else if (['K','Q','J'].includes(card.value)) value += 10;
                    else value += parseInt(card.value);
                });
                while (value > 21 && aces > 0) { value -= 10; aces--; }
                return value;
            })() %></span>
        </div>

        <% if (game.status === 'playing') { %>
        <div class="menu" style="margin-top: 20px;">
            <div class="menu-item">
                <span class="menu-key">H)</span>
                <form action="/provinggrounds/games/blackjack/hit" method="POST" style="display: inline;">
                    <button type="submit">Hit</button>
                </form>
            </div>
            <div class="menu-item">
                <span class="menu-key">S)</span>
                <form action="/provinggrounds/games/blackjack/stand" method="POST" style="display: inline;">
                    <button type="submit">Stand</button>
                </form>
            </div>
        </div>
        <% } else { %>
        <div class="message <%= game.status === 'win' ? 'message-success' : (game.status === 'push' ? 'message-warning' : 'message-error') %>">
            <% if (game.status === 'win') { %>
            <strong>YOU WIN!</strong>
            <p>You won <%= game.bet %> gold!</p>
            <% } else if (game.status === 'lose') { %>
            <strong>DEALER WINS</strong>
            <p>You lost <%= game.bet %> gold.</p>
            <% } else if (game.status === 'bust') { %>
            <strong>BUST!</strong>
            <p>You went over 21! Lost <%= game.bet %> gold.</p>
            <% } else if (game.status === 'push') { %>
            <strong>PUSH</strong>
            <p>It's a tie! Bet returned.</p>
            <% } %>
        </div>

        <form action="/provinggrounds/games/blackjack/start" method="POST" style="margin-top: 20px;">
            <input type="hidden" name="bet" value="<%= game.bet %>">
            <button type="submit">Play Again (Same Bet)</button>
        </form>
        <% } %>
        <% } %>

        <div class="menu" style="margin-top: 20px;">
            <div class="menu-item">
                <span class="menu-key">&lt;</span>
                <a href="/provinggrounds/games">Return to Gambling</a>
            </div>
        </div>

        <div class="status-bar">
            <span>[<%= user.name %>]</span>
            <span>Level: <%= user.level %></span>
            <span>Gold: <%= user.gold %></span>
            <span>HP: <%= user.hp %>/<%= user.max_hp %></span>
        </div>
    </div>
    <script src="/provinggrounds/js/terminal.js"></script>
</body>
</html>
